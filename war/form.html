<!DOCTYPE html>
<html>
<head>
	<title>Widget</title>
	<link rel="stylesheet" type="text/css" href="http://getbootstrap.com/dist/css/bootstrap.min.css"/>
</head>
	<body>
		<div class="container" id="widget_form">
			<form action="sendMessage" method="GET" class="form-horizontal" role="form">
				<input type="text" class="form-control" id="inputLastName" placeholder="Last Name"><br/>
				<input type="text" class="form-control" id="inputFirstName" placeholder="First Name"><br/>
				<input type="text" class="form-control" id="inputPhoneNumber" placeholder="Phone Number"><br/>
				<input type="email" class="form-control" id="inputEmail" placeholder="Email"><br/>
				<select class="form-control" id="selectDepartment" onchange="">
					<option>Choose one department...</option>
					<option>Finance</option>
					<option>Bursar</option>
					<option>Health Care</option>
					<option>Education</option>
					<option>Bla bla</option>
				</select><br/>
			</form>
			<button type="submit" class="btn btn-primary" id="widget_form_button">Chat!</button>
		</div>

		<div class="container" id="widget_chat">
			<textarea disabled rows="25" id="widget_target_communication_textarea" style="width:100%;resize:none;"></textarea>
			<br/>
			<textarea rows="2" placeholder="Type your question here. When done typing, press enter/return" id="widget_target_communication_input" style="width:100%;resize:none;"></textarea>
		</div>
		<script type="text/javascript">
			var body = document.getElementsByTagName('body')[0];
			var form = document.getElementById('widget_form');
			var chat = document.getElementById('widget_chat');
			var chatButton = document.getElementById('widget_form_button');
			var select = document.getElementById('selectDepartment');
			var conversation = document.getElementById('widget_target_communication_textarea');
			var userInput = document.getElementById('widget_target_communication_input');
			var selectOption = 0;
			var urlGetRequest = "";

			if (!String.prototype.contains) {
			    String.prototype.contains = function(s, i) {
			        return this.indexOf(s, i) != -1;
			    }
			}

			var main = function(){
				body.removeChild(chat);
				chatButton.addEventListener('click',
					function(){
						createURLGetRequest();
						body.removeChild(form);
						body.appendChild(chat);
						getInfoServer();
					},true);

				select.addEventListener('change',
					function(){
						selectOption = this.selectedIndex;
					},true);

				userInput.addEventListener('keyup',
					function(event){
						if(event.keyCode == 13 && this.value !== ""){
							sendInfoServer(this.value);
							this.value = "";
							console.log(0);
						}
					},true);
			}

			var createURLGetRequest = function(){
				if(urlGetRequest === ""){
					urlGetRequest = "http://google.com/page?";
					urlGetRequest += "lastname=" + document.getElementById('inputLastName').value;
					urlGetRequest += "&fistname=" + document.getElementById('inputFirstName').value;
					urlGetRequest += "&email=" + document.getElementById('inputEmail').value;
					urlGetRequest += "&department=" + document.getElementById('selectDepartment').options[selectOption].value;
					urlGetRequest += "&phonenumber=" + document.getElementById('inputPhoneNumber').value;
					console.log(urlGetRequest);
				}
				return urlGetRequest;
			}

			var getInfoServer = function() {
				var xmlhttp = (window.XMLHttpRequest) ? new XMLHttpRequest() : new ActiveXObject("Microsoft.XMLHTTP");
				xmlhttp.onreadystatechange = function() {
					console.log('done');
				}

				xmlhttp.open("GET",createURLGetRequest(),true);
				xmlhttp.send();
			}

			var sendInfoServer = function(message) {
				var xmlhttp = (window.XMLHttpRequest) ? new XMLHttpRequest() : new ActiveXObject("Microsoft.XMLHTTP");

				xmlhttp.onreadystatechange = function() {
					if(conversation.value !== undefined && !conversation.value.toString().contains(message))
						conversation.value += message;
				}

				xmlhttp.open("POST","http://1-dot-appspot.com/_ah/xmpp/message/chat/" + message,true);
				xmlhttp.send();
			}
			main();

			// First POST should be: 01234
		</script>
</body>
</html>