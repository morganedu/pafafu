<!DOCTYPE html>
<html>
<head>
	<title>Widget</title>
	<link rel="stylesheet" type="text/css" href="http://getbootstrap.com/dist/css/bootstrap.min.css"/>
	<style type="text/css">
		form input,select{
			margin-bottom: 1%;
		}
	</style>
</head>
	<body>
		<div class="container" id="form_frame">
			<form action="sendMessage" method="GET" class="form-horizontal" role="form">
				<input type="text" class="form-control" id="lastName" placeholder="Last Name">
				<input type="text" class="form-control" id="firstName" placeholder="First Name">
				<input type="text" class="form-control" id="phoneNumber" placeholder="Phone Number">
				<input type="email" class="form-control" id="email" placeholder="Email">
				<select class="form-control" id="form_select">
					<option disabled selected>Choose one department...</option>
					<option>Finance</option>
					<option>Bursar</option>
					<option>Health Care</option>
					<option>Education</option>
				</select>
			</form>
			<button id="form_button" type="submit" class="btn btn-primary">Chat!</button>
		</div>

		<div class="container" id="chat_frame">
			<textarea id="chat_textarea" disabled rows="25" style="width:100%;resize:none;"></textarea>
			<br/>
			<textarea id="chat_input" rows="2" placeholder="Type your question here. When done typing, press enter/return" style="width:100%;resize:none;"></textarea>
		</div>
		<script type="text/javascript">
			var body = document.getElementsByTagName('body')[0];
			var selectOption = 0;
			var baseURI = "/_ah/xmpp/message/chat/";

			var xmlhttp = (window.XMLHttpRequest) ? new XMLHttpRequest() : new ActiveXObject("Microsoft.XMLHTTP");
			var domElements = new Object();
			var userData = null;

			(function(){
				/*IMPORTANT CONFIGURATION*/
				if (!String.prototype.contains) {
				    String.prototype.contains = function(s, i) {
				        return this.indexOf(s, i) != -1;
				    }
				}

				for(var i = 0; i<(arrayID = ['form_frame','form_select','form_button','chat_frame','chat_textarea','chat_input']).length; i++)
					domElements[arrayID[i]] = document.getElementById(arrayID[i]);

				body.removeChild(domElements.chat_frame);

				/*EVENT LISTENERS*/
				domElements.form_button.addEventListener('click',
					function(){
						if(document.getElementById("lastName").value == "" || document.getElementById("firstName").value == ""){
							alert("Empty fields.");
							return;
						}
						else if(!/^\d{10}$/.test(document.getElementById("phoneNumber").value)){
							alert("Invalid phone number. It must contain 10 digits.");
							return;
						}
						else if(!/\S+@\S+\.\S+/.test(document.getElementById("email").value)){
							alert("Invalid email.");
							return;
						}
						else if(document.getElementById('form_select').selectedIndex == 0){
							alert("Select a department.");
							return;
						}
						createUserData();
						body.removeChild(domElements.form_frame);
						body.appendChild(domElements.chat_frame);
						ajaxCall('operator');
					},true);

				domElements.form_select.addEventListener('change',
					function(){
						selectOption = this.selectedIndex;
					},true);

				domElements.chat_input.addEventListener('keyup',
					function(event){
						if(event.keyCode == 13 && this.value !== ""){
							ajaxCall('message');
						}
					},true);
			})();

			var createUserData = function(){
				if(userData === null){
					userData = new Object({
						department: document.getElementById('form_select').options[selectOption].value,
						jid: 'xxxxxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
						    var r = Math.random()*16|0, v = c == 'x' ? r : (r&0x3|0x8);
						    return v.toString(16);
						}) + '@morgan.edu',
						readyCode: '01234'
					});

					for(var i = 0; i<(arrayInput = ['lastName','firstName','email','phoneNumber']).length; i++)
						userData[arrayInput[i]] = document.getElementById(arrayInput[i]).value;

					userData.getURI = function(){
						return baseURI + "?"
							+ "lastName=" + userData.lastName 
							+ "&firstName=" + userData.firstName
							+ "&email=" + userData.email
							+ "&department=" + userData.department 
							+ "&phoneNumber=" + userData.phoneNumber 
							+ "&jid=" + userData.jid
							+ "&get=" + "true";
					}
				}
			}

			var ajaxCall = function(concept){
				if(concept.contains('message')){
					xmlhttp.onreadystatechange = sendMessage();
					xmlhttp.open("POST",baseURI + domElements.chat_input.value,true);
				} else if(concept.contains('operator')){
					xmlhttp.onreadystatechange = getOperator();
					xmlhttp.open("GET",userData.getURI(),true);
				} else if(concept.contains('token')){
					xmlhttp.onreadystatechange = sendTokenStartChat();
					xmlhttp.open("POST",baseURI + userData.readyCode,true);
				}
				xmlhttp.send();
			}

			var sendMessage = function(){
				if(xmlhttp.readyState==4 && xmlhttp.status==200){
					domElements.chat_textarea.value += domElements.chat_input.value;
					domElements.chat_input.value = "";
				}
				else{
					domElements.chat_textarea.value += "Error: " + domElements.chat_input.value;
					domElements.chat_input.value = "";
				}
			}

			var getOperator = function(){
				if(xmlhttp.readyState==4 && xmlhttp.status==200){
					domElements.chat_frame.innerHTML = xmlhttp.responseText;
					console.log(xmlhttp.responseText);

					domElements.chat_textarea = document.getElementById('chat_textarea');
					domElements.chat_input = document.getElementById('chat_input');

					domElements.chat_input.addEventListener('keyup',
					function(event){
						if(event.keyCode == 13 && this.value !== ""){
							ajaxCall('message');
						}
					},true);
					ajaxCall('token');
				}
			}

			var sendTokenStartChat = function(){
				if(xmlhttp.readyState==4 && xmlhttp.status==200){
					console.log('Send 01234 to Tunde');
				}
			}
		</script>
</body>
</html>