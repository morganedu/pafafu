<!DOCTYPE html>
<html>
<head>
	<title>Widget</title>
	<link rel="stylesheet" type="text/css" href="bootstrap.min.css"/>
	<link rel="stylesheet" type="text/css" href="form.css">
</head>
	<body>
		<div class="container" id="loading_frame">
			<div class="bubblingG">
				<span id="bubblingG_1"></span>
				<span id="bubblingG_2"></span>
				<span id="bubblingG_3"></span>
			</div>
		</div>
		<div class="container image-center">
			<img class="image-center" src="http://www.cfmengineering.com/projects/images/morgan_logo.jpg" >
		</div>
		<div class="container" id="form_frame">
			<form action="sendMessage" method="GET" class="form-horizontal" role="form">
				<input type="text" class="form-control" id="lastName" placeholder="Last Name">
				<input type="text" class="form-control" id="firstName" placeholder="First Name">
				<input type="text" class="form-control" id="phoneNumber" placeholder="Phone Number">
				<input type="email" class="form-control" id="email" placeholder="Email">
				<select class="form-control" id="form_select">
					<option disabled selected>Choose one department...</option>
					<option>Finance</option>
					<option>Bursar</option>
					<option>Health Care</option>
					<option>Education</option>
				</select>
			</form>
			<button id="form_button" type="submit" class="btn btn-primary">Chat!</button>
		</div>

		<div class="container" id="chat_frame">
		</div>
		<script type="text/javascript">
			var body = document.getElementsByTagName('body')[0];
			var selectOption = 0;
			var baseURI = "/_ah/xmpp/message/chat/";
			var old_textarea_cursor = '';

			var xmlhttp = (window.XMLHttpRequest) ? new XMLHttpRequest() : new ActiveXObject("Microsoft.XMLHTTP");
			var domElements = new Object();
			var userData = null;

			(function(){
				/*IMPORTANT CONFIGURATION*/
				if (!String.prototype.contains) {
				    String.prototype.contains = function(s, i) {
				        return this.indexOf(s, i) != -1;
				    }
				}

				for(var i = 0; i<(arrayID = ['loading_frame','form_frame','form_select','form_button','chat_frame','chat_textarea','chat_input']).length; i++)
					domElements[arrayID[i]] = document.getElementById(arrayID[i]);

				body.removeChild(domElements.chat_frame);
				domElements.loading_frame.style.visibility = 'hidden';

				/*EVENT LISTENERS*/
				domElements.form_button.addEventListener('click',
					function(){
						if(document.getElementById("lastName").value == "" || document.getElementById("firstName").value == ""){
							alert("Empty fields.");
							return;
						}
						else if(!/^\d{10}$/.test(document.getElementById("phoneNumber").value)){
							alert("Invalid phone number. It must contain 10 digits.");
							return;
						}
						else if(!/\S+@\S+\.\S+/.test(document.getElementById("email").value)){
							alert("Invalid email.");
							return;
						}
						else if(document.getElementById('form_select').selectedIndex == 0){
							alert("Select a department.");
							return;
						}
						console.log(0);
						domElements.loading_frame.style.visibility = 'visible';
						console.log(1);
						createUserData();
						ajaxCall('operator');

					},true);

				domElements.form_select.addEventListener('change',
					function(){
						selectOption = this.selectedIndex;
					},true);
			})();

			var createUserData = function(){
				if(userData === null){
					userData = new Object({
						department: document.getElementById('form_select').options[selectOption].value,
						jid: 'xxxxxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
						    var r = Math.random()*16|0, v = c == 'x' ? r : (r&0x3|0x8);
						    return v.toString(16);
						}) + '@morgan.edu',
						readyCode: '01234'
					});

					for(var i = 0; i<(arrayInput = ['lastName','firstName','email','phoneNumber']).length; i++)
						userData[arrayInput[i]] = document.getElementById(arrayInput[i]).value;

					userData.getURI = function(){
						return baseURI + "?"
							+ "lastName=" + userData.lastName 
							+ "&firstName=" + userData.firstName
							+ "&email=" + userData.email
							+ "&department=" + userData.department 
							+ "&phoneNumber=" + userData.phoneNumber 
							+ "&jid=" + userData.jid
							+ "&get=" + "true";
					}
				}
			}

			var ajaxCall = function(concept){
				if(concept.contains('message')){
					xmlhttp.onreadystatechange = 
						function(){
							if(xmlhttp.readyState==4 && xmlhttp.status==200 && domElements.chat_input.value !== ""){
								domElements.chat_textarea.value += userData.lastName + ": " + domElements.chat_input.value;
								domElements.chat_input.value = "";
							}
							else{
								if(domElements.chat_input.value !== ""){
									domElements.chat_textarea.value += userData.lastName + "~ERROR~ " + domElements.chat_input.value;
									domElements.chat_input.value = "";
								}
							}
						}
					xmlhttp.open("POST",baseURI + domElements.chat_input.value,true);
				}
				else if(concept.contains('operator')){
					xmlhttp.onreadystatechange = 
						function(){
							console.log(xmlhttp.responseText);
							if(xmlhttp.readyState==4 && xmlhttp.status==200){
								/*Add reponse to the chat_frame*/
								body.appendChild(domElements.chat_frame);
								domElements.chat_frame.innerHTML = xmlhttp.responseText;

								/*Add the objects from response into the domElements object*/
								domElements.chat_textarea = document.getElementById('chat_textarea');
								domElements.chat_input = document.getElementById('chat_input');

								domElements.chat_input.addEventListener('keyup',
								function(event){
									if(event.keyCode == 13 && this.value !== ""){
										ajaxCall('message');
									}
								},true);

								domElements.chat_textarea.addEventListener('keyup',reset,true);

								domElements.loading_frame.style.visibility = 'hidden';
								body.removeChild(domElements.form_frame);
								ajaxCall('token');
							}
						}
					xmlhttp.open("GET",userData.getURI(),true);
				}
				else if(concept.contains('token')){
					xmlhttp.onreadystatechange = 
						function(){
							if(xmlhttp.readyState==4 && xmlhttp.status==200){
								console.log('Send 01234 to Tunde');
							}
						}
					xmlhttp.open("POST",baseURI + userData.readyCode,true);
				}
				xmlhttp.send();
			}

			var reset = function (e) {
				var val = this.value
					, len = val.length;

				this.setSelectionRange(len, len);

				// To fix android chrome bug
				// although good practise just incase
				// user is using some other browser/os combination
				// with similar issue.
				if (e.type === 'keyup' || e.type === 'keydown') {
					var short, long;
					if (old_textarea_cursor.length < val.length) {
						short = old_textarea_cursor;
						long = val;
					}
					else {
						short = val;
						long = old_textarea_cursor;
					}
					
					if (long.indexOf(short) !== 0) {
						val = old_textarea_cursor;
						this.value = val;
						this.setSelectionRange(old_textarea_cursor.length, old_textarea_cursor.length);
						
						e.preventDefault();
						// Just exit from the function now
						return false;
					}
				}

				old_textarea_cursor = val;
			};
		</script>
</body>
</html>