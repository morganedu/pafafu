var body=document.getElementsByTagName("body")[0];var selectOption=0;var baseURI="/_ah/xmpp/message/chat/";var old_textarea_cursor="";var xmlhttp=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");var domElements=new Object;var userData=null;(function(){if(!String.prototype.contains){String.prototype.contains=function(e,t){return this.indexOf(e,t)!=-1}}for(var e=0;e<(arrayID=["loading_frame","form_frame","form_select","form_button","chat_frame","chat_textarea","chat_input"]).length;e++)domElements[arrayID[e]]=document.getElementById(arrayID[e]);body.removeChild(domElements.chat_frame);domElements.loading_frame.style.visibility="hidden";domElements.form_button.addEventListener("click",function(){if(document.getElementById("lastName").value==""||document.getElementById("firstName").value==""){alert("Empty fields.");return}else if(!/^\d{10}$/.test(document.getElementById("phoneNumber").value)){alert("Invalid phone number. It must contain 10 digits.");return}else if(!/\S+@\S+\.\S+/.test(document.getElementById("email").value)){alert("Invalid email.");return}else if(document.getElementById("form_select").selectedIndex==0){alert("Select a department.");return}domElements.loading_frame.style.visibility="visible";createUserData();ajaxCall("operator")},true);domElements.form_select.addEventListener("change",function(){selectOption=this.selectedIndex},true)})();var createUserData=function(){if(userData===null){userData=new Object({department:document.getElementById("form_select").options[selectOption].value,jid:"xxxxxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,n=e=="x"?t:t&3|8;return n.toString(16)})+"@morgan.edu",readyCode:"01234"});for(var e=0;e<(arrayInput=["lastName","firstName","email","phoneNumber"]).length;e++)userData[arrayInput[e]]=document.getElementById(arrayInput[e]).value;userData.getURI=function(){return baseURI+"?"+"lastName="+userData.lastName+"&firstName="+userData.firstName+"&email="+userData.email+"&department="+userData.department+"&phoneNumber="+userData.phoneNumber+"&jid="+userData.jid+"&get="+"true"}}};var ajaxCall=function(e){if(e.contains("message")){xmlhttp.onreadystatechange=function(){if(xmlhttp.readyState==4&&xmlhttp.status==200&&domElements.chat_input.value!==""){domElements.chat_textarea.value+=userData.lastName+": "+domElements.chat_input.value;domElements.chat_input.value=""}};xmlhttp.open("POST",baseURI,true);xmlhttp.send("message="+domElements.chat_input.value)}else if(e.contains("operator")){xmlhttp.onreadystatechange=function(){console.log(xmlhttp.responseText);if(xmlhttp.readyState==4&&xmlhttp.status==200){body.appendChild(domElements.chat_frame);domElements.chat_frame.innerHTML=xmlhttp.responseText;domElements.chat_textarea=document.getElementById("chat_textarea");domElements.chat_input=document.getElementById("chat_input");domElements.chat_input.addEventListener("keyup",function(e){if(e.keyCode==13&&this.value!==""){ajaxCall("message")}},true);domElements.loading_frame.style.visibility="hidden";body.removeChild(domElements.form_frame);ajaxCall("token")}};xmlhttp.open("GET",userData.getURI(),true);xmlhttp.send()}else if(e.contains("token")){xmlhttp.onreadystatechange=function(){if(xmlhttp.readyState==4&&xmlhttp.status==200){console.log(xmlhttp.responseText)}};xmlhttp.open("POST",baseURI,true);xmlhttp.send("token="+userData.readyCode)}}